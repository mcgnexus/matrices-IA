<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculadora de Matrices con IA</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      background-color: #FFFFFF;
      font-family: 'Roboto', sans-serif;
      color: #333333;
      margin: 0;
      padding: 20px;
      line-height: 1.6;
    }
    
    h1, h2 {
      font-family: 'Montserrat', sans-serif;
      color: #3498DB;
      text-align: center;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      background-color: #FFFFFF;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .section {
      margin-bottom: 30px;
      padding: 20px;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      background-color: #fafafa;
    }
    
    .input-group {
      margin-bottom: 15px;
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    label {
      font-weight: 500;
      margin-right: 5px;
      color: #2c3e50;
    }
    
    input[type="number"], input[type="text"] {
      padding: 8px 12px;
      font-size: 16px;
      border: 2px solid #3498DB;
      border-radius: 6px;
      transition: border-color 0.3s, box-shadow 0.3s;
    }
    
    input[type="number"]:focus, input[type="text"]:focus {
      outline: none;
      border-color: #2980B9;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
    }
    
    input[type="text"] {
      width: 300px;
      min-width: 250px;
    }
    
    button {
      background-color: #2ECC71;
      color: #FFFFFF;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-family: 'Montserrat', sans-serif;
      font-weight: 500;
      margin-right: 10px;
      margin-bottom: 5px;
      transition: all 0.3s ease;
      position: relative;
    }
    
    button:hover:not(:disabled) {
      background-color: #27AE60;
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    button:disabled {
      background-color: #95a5a6;
      cursor: not-allowed;
      transform: none;
    }
    
    .loading {
      opacity: 0.7;
    }
    
    .loading::after {
      content: "";
      position: absolute;
      width: 16px;
      height: 16px;
      margin: auto;
      border: 2px solid transparent;
      border-top-color: #ffffff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    table {
      border-collapse: collapse;
      margin: 20px auto;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    td {
      border: 1px solid #3498DB;
      padding: 8px 12px;
      text-align: center;
      background-color: white;
    }
    
    input.matrix-input {
      width: 70px;
      text-align: center;
      border: 1px solid #bdc3c7;
      border-radius: 4px;
      padding: 6px;
      font-size: 14px;
    }
    
    input.matrix-input:focus {
      border-color: #3498DB;
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }
    
    .matrix-display {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      border: 1px solid #dee2e6;
    }
    
    .matrix-display td {
      background-color: #e3f2fd;
      font-weight: 500;
      color: #1565c0;
    }
    
    #result {
      margin-top: 20px;
      padding: 20px;
      border: 2px solid #3498DB;
      border-radius: 8px;
      display: none;
      background-color: #f0f8ff;
      animation: fadeIn 0.5s ease-in-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    #result.error {
      border-color: #e74c3c;
      background-color: #fdf2f2;
      color: #c0392b;
    }
    
    #result.success {
      border-color: #27ae60;
      background-color: #f0fff4;
    }
    
    .operation-help {
      font-size: 12px;
      color: #7f8c8d;
      margin-top: 5px;
      font-style: italic;
    }
    
    .suggestions {
      margin-top: 10px;
    }
    
    .suggestion-chip {
      display: inline-block;
      background-color: #ecf0f1;
      color: #2c3e50;
      padding: 4px 8px;
      margin: 2px 4px 2px 0;
      border-radius: 12px;
      font-size: 12px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    .suggestion-chip:hover {
      background-color: #d5dbdb;
    }
    
    .error-message {
      color: #e74c3c;
      background-color: #fdf2f2;
      padding: 10px;
      border-radius: 6px;
      margin: 10px 0;
      border-left: 4px solid #e74c3c;
    }
    
    .success-message {
      color: #27ae60;
      background-color: #f0fff4;
      padding: 10px;
      border-radius: 6px;
      margin: 10px 0;
      border-left: 4px solid #27ae60;
    }
    
    /* Responsive design */
    @media (max-width: 768px) {
      .container {
        padding: 10px;
        margin: 10px;
      }
      
      .input-group {
        flex-direction: column;
        align-items: stretch;
      }
      
      input[type="text"] {
        width: 100%;
        min-width: unset;
      }
      
      button {
        width: 100%;
        margin-right: 0;
      }
      
      table {
        font-size: 14px;
      }
      
      input.matrix-input {
        width: 60px;
        font-size: 12px;
      }
    }
    
    /* Mejoras de accesibilidad */
    button:focus, input:focus {
      outline: 2px solid #3498DB;
      outline-offset: 2px;
    }
    
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }
  </style>
</head>
<body>
  <div class="sr-only">
    <h1>Calculadora de Matrices con IA - Aplicación accesible</h1>
  </div>
  
  <h1>Calculadora de Matrices con IA</h1>
  
  <div class="container">
    <!-- Sección 1: Crear Matriz -->
    <div class="section">
      <h2>1. Crear Matriz</h2>
      <div class="input-group">
        <label for="rows">Filas:</label>
        <input type="number" id="rows" min="1" max="10" value="3" aria-describedby="matrix-size-help">
        <label for="cols">Columnas:</label>
        <input type="number" id="cols" min="1" max="10" value="3" aria-describedby="matrix-size-help">
        <button onclick="generateMatrix()" id="create-matrix-btn">Crear matriz</button>
      </div>
      <div id="matrix-size-help" class="operation-help">
        Máximo 10x10. Para matrices grandes, el procesamiento puede ser más lento.
      </div>
      <div id="matrix-container" role="region" aria-label="Contenedor de matriz"></div>
    </div>

    <!-- Sección 2: Matriz Creada -->
    <div class="section" id="matrix-display-section" style="display: none;" role="region" aria-labelledby="matrix-display-title">
      <h2 id="matrix-display-title">2. Matriz Creada</h2>
      <div id="matrix-display" class="matrix-display" aria-label="Matriz actual"></div>
    </div>

    <!-- Sección 3: Operaciones -->
    <div class="section" id="operations-section" style="display: none;" role="region" aria-labelledby="operations-title">
      <h2 id="operations-title">3. Operaciones Disponibles</h2>
      <div class="input-group">
        <label for="operation">Operación:</label>
        <input type="text" id="operation" placeholder="Ej: inversa, determinante, traspuesta" 
               aria-describedby="operation-help" list="operations-list">
        <datalist id="operations-list">
          <option value="inversa">
          <option value="determinante">
          <option value="traspuesta">
          <option value="adjunta">
          <option value="rango">
          <option value="eigenvalores">
          <option value="triangular superior">
          <option value="descomposición lu">
        </datalist>
      </div>
      <div id="operation-help" class="operation-help">
        Ejemplos: inversa, traspuesta, determinante, rango, eigenvalores, triangular superior, descomposición LU
      </div>
      <div class="suggestions" id="suggestions" style="display: none;">
        <strong>Sugerencias:</strong>
        <div id="suggestion-chips"></div>
      </div>
      <button onclick="processOperation()" id="calculate-btn">Calcular</button>
      <button onclick="clearAll()" id="clear-btn" style="background-color: #e74c3c;">Limpiar todo</button>
    </div>

    <!-- Resultados -->
    <div id="result" role="region" aria-live="polite" aria-label="Resultados del cálculo"></div>
  </div>

  <script>
    let currentMatrix = [];
    let isProcessing = false;

    // Operaciones sugeridas
    const operationSuggestions = [
      'inversa', 'determinante', 'traspuesta', 'adjunta', 'rango',
      'eigenvalores', 'triangular superior', 'descomposición lu', 'norma', 'traza'
    ];

    function generateMatrix() {
      const rows = parseInt(document.getElementById('rows').value);
      const cols = parseInt(document.getElementById('cols').value);
      
      if (rows <= 0 || cols <= 0 || rows > 10 || cols > 10) {
        showError('Por favor, ingresa dimensiones válidas (1-10)');
        return;
      }

      let html = '<table role="table" aria-label="Matriz de entrada">';
      html += '<caption class="sr-only">Matriz de ' + rows + ' filas por ' + cols + ' columnas</caption>';
      
      for (let i = 0; i < rows; i++) {
        html += '<tr>';
        for (let j = 0; j < cols; j++) {
          html += `<td><input type="number" class="matrix-input" id="cell-${i}-${j}" 
                   step="any" value="0" aria-label="Elemento [${i+1},${j+1}]"></td>`;
        }
        html += '</tr>';
      }
      html += '</table>';
      html += '<button onclick="saveMatrix()" id="save-matrix-btn">Guardar Matriz</button>';
      html += '<button onclick="fillRandom()" style="background-color: #9b59b6;">Llenar Aleatorio</button>';
      
      document.getElementById('matrix-container').innerHTML = html;
      
      // Focus en el primer input
      setTimeout(() => {
        document.getElementById('cell-0-0')?.focus();
      }, 100);
    }

    function fillRandom() {
      const rows = parseInt(document.getElementById('rows').value);
      const cols = parseInt(document.getElementById('cols').value);
      
      for (let i = 0; i < rows; i++) {
        for (let j = 0; j < cols; j++) {
          const element = document.getElementById(`cell-${i}-${j}`);
          if (element) {
            element.value = Math.floor(Math.random() * 20) - 10; // Números entre -10 y 9
          }
        }
      }
    }

    function saveMatrix() {
      const rows = parseInt(document.getElementById('rows').value);
      const cols = parseInt(document.getElementById('cols').value);
      
      currentMatrix = [];
      let hasEmptyValues = false;
      
      for (let i = 0; i < rows; i++) {
        let row = [];
        for (let j = 0; j < cols; j++) {
          const element = document.getElementById(`cell-${i}-${j}`);
          const value = element?.value?.trim();
          
          if (!value) {
            hasEmptyValues = true;
            element?.focus();
            showError(`Campo vacío en posición [${i+1},${j+1}]. Por favor, completa todos los campos.`);
            return;
          }
          
          const numValue = parseFloat(value);
          if (isNaN(numValue)) {
            element?.focus();
            showError(`Valor inválido "${value}" en posición [${i+1},${j+1}]. Ingresa solo números.`);
            return;
          }
          row.push(numValue);
        }
        currentMatrix.push(row);
      }

      // Mostrar matriz creada
      displayCreatedMatrix();
      
      // Mostrar secciones
      document.getElementById('matrix-display-section').style.display = 'block';
      document.getElementById('operations-section').style.display = 'block';
      
      showSuccess('Matriz guardada correctamente. Ahora puedes realizar operaciones.');
      
      // Focus en el input de operación
      setTimeout(() => {
        document.getElementById('operation')?.focus();
      }, 100);
    }

    function displayCreatedMatrix() {
      let html = '<table class="matrix-display" role="table" aria-label="Matriz guardada">';
      html += `<caption class="sr-only">Matriz guardada de ${currentMatrix.length} filas por ${currentMatrix[0].length} columnas</caption>`;
      
      for (let i = 0; i < currentMatrix.length; i++) {
        html += '<tr>';
        for (let j = 0; j < currentMatrix[i].length; j++) {
          html += `<td aria-label="Elemento [${i+1},${j+1}]: ${currentMatrix[i][j]}">${currentMatrix[i][j]}</td>`;
        }
        html += '</tr>';
      }
      html += '</table>';
      
      document.getElementById('matrix-display').innerHTML = html;
    }

    async function processOperation() {
      if (isProcessing) return;
      
      const operation = document.getElementById('operation').value.trim();
      
      if (!operation) {
        showError('Por favor, especifica una operación.');
        document.getElementById('operation').focus();
        return;
      }

      if (currentMatrix.length === 0) {
        showError('Por favor, crea y guarda una matriz primero.');
        return;
      }

      isProcessing = true;
      const calculateBtn = document.getElementById('calculate-btn');
      const originalText = calculateBtn.textContent;
      
      // UI de carga
      calculateBtn.disabled = true;
      calculateBtn.classList.add('loading');
      calculateBtn.textContent = 'Procesando...';

      const resultDiv = document.getElementById('result');
      resultDiv.style.display = 'block';
      resultDiv.className = '';
      resultDiv.innerHTML = `
        <div style="text-align: center;">
          <p>🔄 Procesando operación "${operation}"...</p>
          <p style="font-size: 14px; color: #7f8c8d;">Esto puede tomar unos segundos</p>
        </div>
      `;

      try {
        const response = await fetch('/api/process-matrix', {
          method: 'POST',
          headers: { 
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({ 
            matrix: currentMatrix, 
            operation: operation 
          })
        });
        
        // Intentar parsear la respuesta
        let data;
        try {
          data = await response.json();
        } catch (parseError) {
          console.error('Error al parsear respuesta:', parseError);
          throw new Error(`Error del servidor: ${response.status} ${response.statusText}`);
        }
        
        if (!response.ok) {
          // Crear error con información completa
          const error = new Error(data.error || `Error ${response.status}`);
          error.details = data.details;
          error.suggestion = data.suggestion;
          error.status = response.status;
          error.data = data;
          throw error;
        }
        
        // Mostrar resultado exitoso
        resultDiv.className = 'success';
        resultDiv.innerHTML = `
          <h3>✅ Resultado</h3>
          <div style="margin: 15px 0;">
            <strong>Matriz original (${currentMatrix.length}×${currentMatrix[0].length}):</strong>
            <div class="matrix-display">${matrixToHTML(currentMatrix)}</div>
          </div>
          <div style="margin: 15px 0;">
            <strong>Operación:</strong> <em>${data.operation}</em>
          </div>
          <div style="margin: 15px 0;">
            <strong>Resultado:</strong>
            <div style="background-color: white; padding: 15px; border-radius: 6px; margin-top: 10px; white-space: pre-wrap;">${data.llm_response}</div>
          </div>
          ${data.suggestions?.length ? `
          <div style="margin-top: 15px;">
            <strong>Otras operaciones que podrías probar:</strong>
            <div style="margin-top: 8px;">
              ${data.suggestions.map(s => `<span class="suggestion-chip" onclick="fillOperation('${s}')">${s}</span>`).join('')}
            </div>
          </div>` : ''}
          <div style="font-size: 12px; color: #7f8c8d; margin-top: 15px;">
            Procesado el ${new Date(data.timestamp).toLocaleString('es-ES')}
          </div>
        `;
        
      } catch (error) {
        console.error('Error completo:', error);
        
        // Extraer mensaje de error apropiado
        let errorMessage = 'Error desconocido';
        let errorDetails = '';
        let suggestions = [];
        let debugInfo = '';
        
        // Log completo para debugging
        console.log('Tipo de error:', typeof error);
        console.log('Error keys:', Object.keys(error));
        console.log('Error stringificado:', JSON.stringify(error, null, 2));
        
        if (typeof error === 'string') {
          errorMessage = error;
        } else if (error.message) {
          errorMessage = error.message;
          debugInfo = `Tipo: ${error.constructor.name}, Stack: ${error.stack}`;
        } else if (error.error) {
          errorMessage = error.error;
          if (error.details) errorDetails = error.details;
          if (error.suggestion) suggestions.push(error.suggestion);
        } else if (error.details) {
          errorMessage = error.details;
        } else {
          // Último recurso: convertir a string
          errorMessage = String(error);
          debugInfo = `Error object: ${JSON.stringify(error, null, 2)}`;
        }
        
        // Determinar tipo de error y sugerencias específicas
        if (errorMessage.includes('timeout') || errorMessage.includes('Timeout')) {
          errorDetails = 'La operación tardó demasiado tiempo en procesarse.';
          suggestions = [
            'Intenta con una matriz más pequeña (máximo 5×5)',
            'Verifica tu conexión a internet',
            'Algunas operaciones complejas pueden tardar más'
          ];
        } else if (errorMessage.includes('API') || errorMessage.includes('502') || errorMessage.includes('503')) {
          errorDetails = 'Problema de conectividad con el servicio de IA.';
          suggestions = [
            'Verifica tu conexión a internet',
            'El servicio puede estar temporalmente no disponible',
            'Intenta de nuevo en unos minutos'
          ];
        } else if (errorMessage.includes('matriz') || errorMessage.includes('Matrix')) {
          errorDetails = 'Problema con la matriz proporcionada.';
          suggestions = [
            'Verifica que todos los campos contengan números válidos',
            'Algunas operaciones requieren matrices cuadradas',
            'Revisa que no haya celdas vacías'
          ];
        } else if (errorMessage.includes('operación') || errorMessage.includes('operation')) {
          errorDetails = 'La operación solicitada no es válida o no se puede realizar.';
          suggestions = [
            'Verifica que la operación esté escrita correctamente',
            'Usa una de las operaciones sugeridas',
            'Algunas operaciones tienen requisitos específicos'
          ];
        } else {
          errorDetails = 'Se produjo un error inesperado.';
          suggestions = [
            'Verifica que la operación esté escrita correctamente',
            'Algunas operaciones requieren matrices cuadradas',
            'Intenta con una matriz más pequeña',
            'Revisa la conexión a internet'
          ];
        }
        
        // Mostrar error detallado
        resultDiv.className = 'error';
        resultDiv.innerHTML = `
          <h3>❌ Error al procesar</h3>
          <div style="margin: 15px 0;">
            <strong>Problema:</strong> ${errorMessage}
          </div>
          ${errorDetails ? `
          <div style="margin: 15px 0;">
            <strong>Detalles:</strong> ${errorDetails}
          </div>` : ''}
          <div style="margin: 15px 0;">
            <strong>Sugerencias:</strong>
            <ul style="margin: 8px 0; padding-left: 20px;">
              ${suggestions.map(s => `<li>${s}</li>`).join('')}
            </ul>
          </div>
          <div style="margin-top: 15px;">
            <button onclick="retryOperation()" style="background-color: #3498DB; margin-right: 10px;">
              🔄 Reintentar
            </button>
            <button onclick="showErrorDebugInfo('${btoa(JSON.stringify({error: errorMessage, details: errorDetails, debugInfo}))}')" style="background-color: #95a5a6;">
              🔍 Ver detalles técnicos
            </button>
          </div>
          <div id="error-debug-info" style="display: none; margin-top: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 4px; font-family: monospace; font-size: 12px; white-space: pre-wrap; border: 1px solid #dee2e6;"></div>
        `;
      } finally {
        // Restaurar UI
        isProcessing = false;
        calculateBtn.disabled = false;
        calculateBtn.classList.remove('loading');
        calculateBtn.textContent = originalText;
      }
    }

    function retryOperation() {
      processOperation();
    }

    function fillOperation(operation) {
      document.getElementById('operation').value = operation;
      document.getElementById('operation').focus();
    }

    function matrixToHTML(matrix) {
      let html = '<table class="matrix-display" role="table" aria-label="Matriz resultado">';
      for (let i = 0; i < matrix.length; i++) {
        html += '<tr>';
        for (let j = 0; j < matrix[i].length; j++) {
          html += `<td>${typeof matrix[i][j] === 'number' ? matrix[i][j].toFixed(4).replace(/\.?0+$/, '') : matrix[i][j]}</td>`;
        }
        html += '</tr>';
      }
      html += '</table>';
      return html;
    }

    function showError(message) {
      // Remover mensajes anteriores
      document.querySelectorAll('.error-message, .success-message').forEach(el => el.remove());
      
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error-message';
      errorDiv.innerHTML = `<strong>Error:</strong> ${message}`;
      errorDiv.setAttribute('role', 'alert');
      
      // Insertar después del elemento activo o al inicio del container
      const activeSection = document.querySelector('.section:not([style*="display: none"])');
      if (activeSection) {
        activeSection.appendChild(errorDiv);
      }
      
      // Auto-remover después de 5 segundos
      setTimeout(() => {
        errorDiv.remove();
      }, 5000);
    }

    function showSuccess(message) {
      // Remover mensajes anteriores
      document.querySelectorAll('.error-message, .success-message').forEach(el => el.remove());
      
      const successDiv = document.createElement('div');
      successDiv.className = 'success-message';
      successDiv.innerHTML = `<strong>Éxito:</strong> ${message}`;
      successDiv.setAttribute('role', 'status');
      
      const activeSection = document.querySelector('.section:not([style*="display: none"])');
      if (activeSection) {
        activeSection.appendChild(successDiv);
      }
      
      // Auto-remover después de 3 segundos
      setTimeout(() => {
        successDiv.remove();
      }, 3000);
    }

    function clearAll() {
      if (confirm('¿Estás seguro de que quieres limpiar todo? Se perderán todos los datos.')) {
        // Limpiar matriz
        currentMatrix = [];
        
        // Ocultar secciones
        document.getElementById('matrix-display-section').style.display = 'none';
        document.getElementById('operations-section').style.display = 'none';
        document.getElementById('result').style.display = 'none';
        
        // Limpiar contenedores
        document.getElementById('matrix-container').innerHTML = '';
        document.getElementById('matrix-display').innerHTML = '';
        document.getElementById('operation').value = '';
        
        // Resetear valores
        document.getElementById('rows').value = '3';
        document.getElementById('cols').value = '3';
        
        // Remover mensajes
        document.querySelectorAll('.error-message, .success-message').forEach(el => el.remove());
        
        showSuccess('Todos los datos han sido limpiados.');
        
        // Focus en el primer input
        document.getElementById('rows').focus();
      }
    }

    // Eventos de teclado para mejor UX
    document.addEventListener('DOMContentLoaded', function() {
      // Enter en inputs numéricos
      document.getElementById('rows').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          document.getElementById('cols').focus();
        }
      });
      
      document.getElementById('cols').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          generateMatrix();
        }
      });
      
      // Enter en operación
      document.getElementById('operation').addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !isProcessing) {
          processOperation();
        }
      });
      
      // Autocompletado dinámico
      document.getElementById('operation').addEventListener('input', function(e) {
        const value = e.target.value.toLowerCase();
        const matches = operationSuggestions.filter(op => 
          op.toLowerCase().includes(value) && value.length > 1
        );
        
        const suggestionsDiv = document.getElementById('suggestions');
        const chipsDiv = document.getElementById('suggestion-chips');
        
        if (matches.length > 0 && value.length > 1) {
          chipsDiv.innerHTML = matches.slice(0, 5).map(op => 
            `<span class="suggestion-chip" onclick="fillOperation('${op}')">${op}</span>`
          ).join('');
          suggestionsDiv.style.display = 'block';
        } else {
          suggestionsDiv.style.display = 'none';
        }
      });
      
      // Focus inicial
      document.getElementById('rows').focus();
    });

    // Navegación con teclado en matriz
    document.addEventListener('keydown', function(e) {
      if (e.target.classList.contains('matrix-input')) {
        const id = e.target.id;
        const [_, row, col] = id.split('-').map(Number);
        const rows = parseInt(document.getElementById('rows').value);
        const cols = parseInt(document.getElementById('cols').value);
        
        let nextRow = row, nextCol = col;
        
        switch(e.key) {
          case 'ArrowUp':
            nextRow = Math.max(0, row - 1);
            e.preventDefault();
            break;
          case 'ArrowDown':
            nextRow = Math.min(rows - 1, row + 1);
            e.preventDefault();
            break;
          case 'ArrowLeft':
            nextCol = Math.max(0, col - 1);
            e.preventDefault();
            break;
          case 'ArrowRight':
          case 'Tab':
            if (e.key === 'Tab' && !e.shiftKey) {
              nextCol = col + 1;
              if (nextCol >= cols) {
                nextCol = 0;
                nextRow = row + 1;
              }
              if (nextRow >= rows) {
                // Focus en botón guardar
                document.getElementById('save-matrix-btn')?.focus();
                e.preventDefault();
                return;
              }
              e.preventDefault();
            } else if (e.key === 'ArrowRight') {
              nextCol = Math.min(cols - 1, col + 1);
              e.preventDefault();
            }
            break;
          case 'Enter':
            nextCol = col + 1;
            if (nextCol >= cols) {
              nextCol = 0;
              nextRow = row + 1;
            }
            if (nextRow >= rows) {
              document.getElementById('save-matrix-btn')?.focus();
              e.preventDefault();
              return;
            }
            e.preventDefault();
            break;
        }
        
        const nextElement = document.getElementById(`cell-${nextRow}-${nextCol}`);
        if (nextElement) {
          nextElement.focus();
          nextElement.select();
        }
      }
    });

    // Prevenir envío de formulario accidental
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && e.target.tagName !== 'BUTTON' && e.target.type !== 'button') {
        // Ya manejado arriba para inputs específicos
      }
    });

    // Información de ayuda contextual
    function showHelp() {
      const helpText = `
        <h3>Ayuda - Calculadora de Matrices</h3>
        <h4>Operaciones disponibles:</h4>
        <ul>
          <li><strong>inversa</strong> - Calcula la matriz inversa (solo matrices cuadradas no singulares)</li>
          <li><strong>determinante</strong> - Calcula el determinante (solo matrices cuadradas)</li>
          <li><strong>traspuesta</strong> - Calcula la matriz traspuesta</li>
          <li><strong>adjunta</strong> - Calcula la matriz adjunta</li>
          <li><strong>rango</strong> - Calcula el rango de la matriz</li>
          <li><strong>eigenvalores</strong> - Calcula los valores propios</li>
          <li><strong>triangular superior</strong> - Forma triangular superior</li>
          <li><strong>descomposición lu</strong> - Descomposición LU</li>
        </ul>
        <h4>Consejos:</h4>
        <ul>
          <li>Use las flechas del teclado para navegar entre celdas</li>
          <li>Presione Enter para avanzar a la siguiente celda</li>
          <li>Use "Llenar Aleatorio" para pruebas rápidas</li>
          <li>Las matrices grandes pueden tardar más en procesarse</li>
        </ul>
      `;
      
      const resultDiv = document.getElementById('result');
      resultDiv.style.display = 'block';
      resultDiv.className = '';
      resultDiv.innerHTML = helpText;
    }

    function showErrorDebugInfo(encodedData) {
      const debugDiv = document.getElementById('error-debug-info');
      if (debugDiv.style.display === 'none') {
        debugDiv.style.display = 'block';
        
        try {
          const debugData = JSON.parse(atob(encodedData));
          debugDiv.textContent = `
Información de depuración completa:

Error principal: ${debugData.error}
Detalles: ${debugData.details || 'N/A'}
Debug info: ${debugData.debugInfo || 'N/A'}

Información del sistema:
- Matriz actual: ${JSON.stringify(currentMatrix, null, 2)}
- Operación: "${document.getElementById('operation').value}"
- Dimensiones: ${currentMatrix.length}×${currentMatrix[0]?.length || 0}
- Navegador: ${navigator.userAgent}
- Timestamp: ${new Date().toISOString()}
- URL actual: ${window.location.href}
          `.trim();
        } catch (e) {
          debugDiv.textContent = `Error al mostrar información de debug: ${e.message}`;
        }
        
        // Cambiar texto del botón
        event.target.textContent = '🔼 Ocultar detalles técnicos';
      } else {
        debugDiv.style.display = 'none';
        event.target.textContent = '🔍 Ver detalles técnicos';
      }
    }

    function showDebugInfo() {
      const debugDiv = document.getElementById('debug-info');
      if (debugDiv.style.display === 'none') {
        debugDiv.style.display = 'block';
        debugDiv.textContent = `
Información de depuración:
- Matriz actual: ${JSON.stringify(currentMatrix, null, 2)}
- Operación: "${document.getElementById('operation').value}"
- Dimensiones: ${currentMatrix.length}×${currentMatrix[0]?.length || 0}
- Navegador: ${navigator.userAgent}
- Timestamp: ${new Date().toISOString()}
        `.trim();
        
        // Cambiar texto del botón
        event.target.textContent = '🔼 Ocultar detalles técnicos';
      } else {
        debugDiv.style.display = 'none';
        event.target.textContent = '🔍 Ver detalles técnicos';
      }
    }

    // Validación en tiempo real
    document.addEventListener('input', function(e) {
      if (e.target.classList.contains('matrix-input')) {
        const value = e.target.value;
        if (value && isNaN(parseFloat(value))) {
          e.target.style.borderColor = '#e74c3c';
          e.target.setAttribute('aria-invalid', 'true');
        } else {
          e.target.style.borderColor = '#bdc3c7';
          e.target.removeAttribute('aria-invalid');
        }
      }
    });
  </script>
</body>
</html>